![Dart](https://img.shields.io/badge/dart-%230175C2.svg?style=for-the-badge&logo=dart&logoColor=white)![Visual Studio Code](https://img.shields.io/badge/Visual%20Studio%20Code-0078d7.svg?style=for-the-badge&logo=visual-studio-code&logoColor=white)![Android Studio](https://img.shields.io/badge/Android%20Studio-3DDC84.svg?style=for-the-badge&logo=android-studio&logoColor=white)![C++](https://img.shields.io/badge/c++-%2300599C.svg?style=for-the-badge&logo=c%2B%2B&logoColor=white)![CMake](https://img.shields.io/badge/CMake-%23008FBA.svg?style=for-the-badge&logo=cmake&logoColor=white)![Xcode](https://img.shields.io/badge/Xcode-007ACC?style=for-the-badge&logo=Xcode&logoColor=white)![Flutter](https://img.shields.io/badge/Flutter-%2302569B.svg?style=for-the-badge&logo=Flutter&logoColor=white)

# AIChatFlutter - Чат-приложение с ИИ

**AIChatFlutter** - это мультиплатформенное приложение для общения с искусственным интеллектом, разработанное с использованием фреймворка **Flutter**. Приложение поддерживает работу как с **OpenRouter.ai**, так и с **VseGPT.ru**, предоставляя гибкие возможности для взаимодействия с различными языковыми моделями.
  
## Особенности сервисов

### OpenRouter.ai

- Префикс API ключа: `sk-or-v1-...`;
- Баланс отображается в долларах ($);
- Стоимость сообщений рассчитывается в долларах за миллион токенов;
- Широкий выбор языковых моделей от разных провайдеров;
- Единый API для доступа к различным моделям.

### VseGPT.ru

- Префикс API ключа: `sk-or-vv-...`;
- Баланс отображается в рублях (₽);
- Стоимость сообщений рассчитывается в рублях за тысячу токенов;
- Доступ к популярным моделям с оплатой в рублях;
- Оптимизировано для пользователей из России.

**Важно для VseGPT**: Чтобы API ключ работал корректно, необходимо в настройках на сайте VseGPT ([https://vsegpt.ru/User/SettingsModels](https://vsegpt.ru/User/SettingsModels)) поставить галочку на **"Разрешить запрашивать баланс по API"**. Без этой настройки приложение не сможет проверить баланс аккаунта.

## Структура проекта

Основные директории и файлы:

-  `lib/` - Основной код приложения;

-  `main.dart` - Точка входа в приложение с AuthenticationWrapper;

-  `api/` - Модули для работы с API;

-  `openrouter_client.dart` - Универсальный клиент для работы с OpenRouter и VseGPT;

-  `models/` - Модели данных;

-  `message.dart` - Модель сообщения с поддержкой токенов и стоимости;

-  `auth_data.dart` - Модель данных аутентификации (ключ, PIN, провайдер, баланс);

-  `providers/` - State management;

-  `chat_provider.dart` - Провайдер для управления состоянием чата;

-  `services/` - Сервисы;

-  `database_service.dart` - Сервис для работы с локальной базой данных (v2 с таблицей auth_data);

-  `auth_service.dart` - Сервис аутентификации (валидация, PIN, баланс);

-  `analytics_service.dart` - Сервис для сбора и анализа статистики;

-  `screens/` - Экраны приложения;

-  `chat_screen.dart` - Основной экран чата;

-  `api_key_entry_screen.dart` - Экран ввода API ключа (первый запуск);

-  `pin_entry_screen.dart` - Экран ввода PIN-кода (последующие запуски);

-  `android/`, `ios/`, `windows/`, `linux/` - Платформо-зависимые конфигурации;

-  `assets/` - Ресурсы приложения;

-  `.env` - Файл конфигурации (создается из .env.example);

-  `pubspec.yaml` - Зависимости проекта.

## Основные модули

### AuthService

- Валидация API-ключей (**OpenRouter** и **VseGPT**);
- Автоматическое определение провайдера по префиксу ключа;
- Проверка баланса аккаунта;
- Генерация и проверка 4-значного PIN-кода;
- Безопасное хранение данных аутентификации;
- Управление сессией пользователя.

### AuthData

- Хранение данных аутентификации;
- **ProviderType** для типизации провайдеров;
- Конвертация в/из JSON для базы данных.

### ChatProvider

- Управление состоянием чата и историей сообщений;
- Взаимодействие с API-ключом (**OpenRouter**/**VseGPT**);
- Отслеживание баланса и расходов;
- Управление моделями и их настройками;
- Интеграция с **AuthService** для получения ключа.

### Message

- Хранение текста сообщений;
- Учет использованных токенов;
- Расчет стоимости сообщений;
- Метаданные (временные метки, модель).

### OpenRouterClient

- Унифицированный интерфейс для работы с API-ключом;
- Автоматическое определение провайдера (**OpenRouter**/**VseGPT**);
- Форматирование цен в соответствии с провайдером;
- Обработка ошибок и повторные попытки;
- Использует **AuthService** для получения токена и URL.

### DatabaseService

- Локальное хранение истории сообщений;
- Хранение данных аутентификации (таблица `auth_data`);
- Кэширование данных;
- Экспорт истории;
- Статистика использования.

### AnalyticsService

- Сбор статистики использования;
- Анализ эффективности моделей;
- Отслеживание времени ответа;
- Анализ использования токенов.

## Функциональность приложения

### Система безопасности

- Двухэтапная аутентификация (API ключ + PIN);
- Автоматическое определение провайдера;
- Валидация ключей перед сохранением;
- Проверка баланса при входе;
- Возможность сброса и смены API ключа;
- Защищенное локальное хранение;

### Основные возможности

- Обмен сообщениями с различными языковыми моделями;
- Выбор модели из доступного списка;
- Отображение баланса;
- Подсчет стоимости каждого сообщения;
- Отслеживание использования токенов.

### Управление чатом

- Сохранение истории сообщений;
- Экспорт истории в JSON;
- Копирование сообщений в буфер обмена;
- Очистка истории.

### Аналитика

- Статистика использования моделей;
- Анализ времени ответа;
- Отслеживание расхода токенов;
- Экспорт аналитических данных.

### Интерфейс

- Адаптивный дизайн;
- Информативные уведомления;
- Интуитивные экраны входа.

### Технические особенности

- Кроссплатформенность (Android, iOS, Windows, Linux);
- Локальное хранение данных;
- Оффлайн доступ к истории;
- Обработка ошибок сети;
- Автоматическая миграция базы данных.

### База данных

База данных содержит 2 основные таблицы:
1.  **messages** - история сообщений (`id`, `content`, `isUser`, `timestamp`, `tokens`, `cost`, `model`)

2.  **auth_data** - данные аутентификации (`id`, `apiKey`, `pinCode`, `provider`, `balance`, `createdAt`)

## Начало работы

### Требования к разработке

- Flutter SDK 3.6.0 или выше;
- Dart SDK 3.6.0 или выше;
- Для Windows: Visual Studio 2022 с C++ tools;
- Для Android: Android Studio с Android SDK;
- Для iOS: Xcode 14 или выше (только macOS);

### Предварительная подготовка

1. Клонируйте мой репозиторий и переходите в рабочую директорию:

```bash
git  clone  https://github.com/ArtemMusienko/AIChatFlutter.git
cd  AIChatFlutter
```

2. Создайте файл `.env` на основе `.env.example`:

```bash
copy  .env.example  .env  # Windows
cp  .env.example  .env  # Linux/macOS
```

3. Следуйте инструкциям в файле [INSTALL.md](INSTALL.md) для установки зависимостей.

### Первый запуск приложения

1. Получите свой API-ключ на одном из следующих сервисов:

-  **OpenRouter**: https://openrouter.ai/keys (ключ начинается с `sk-or-v1-`)
-  **VseGPT**: https://vsetgpt.ru (ключ начинается с `sk-or-vv-`)

2. Введите следующую консольную команду, запустив приложение:

```bash
    flutter  run
```
    
3. В появившемся интерфейсе введите ваш API-ключ (система автоматически определит провайдер и проверит баланс). После успешной проверки ключа будет сгенерирован PIN-код.

> **Важно**: Запомните или запишите PIN-код!

### Возможные проблемы с аутентификацией

-  **Неверный формат ключа**: Убедитесь, что ключ начинается с `sk-or-v1-` (OpenRouter) или `sk-or-vv-` (VseGPT);
-  **Ошибка проверки баланса**: Проверьте подключение к интернету и валидность ключа;
-  **Забыли PIN**: Используйте кнопку "Сбросить API ключ" для ввода нового ключа.

> **Примечание**: API ключ вводится через интерфейс приложения при первом запуске, значение в `.env` используется только как резервное.

## Пример интерфейса приложения

<div align="center">

|                                                                                                                 |                                                                                                                 |
|:-----------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------|
| <img src="https://github.com/user-attachments/assets/188b6057-1c0f-4c99-9276-d77e1c60a2ff" width="600" style="border-radius:22px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); border: 1px solid #333;" alt="Главный экран"/> | <img src="https://github.com/user-attachments/assets/3bba982f-d383-49f8-b00b-e17236a7377c" width="600" style="border-radius:22px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); border: 1px solid #333;" alt="Чат с ИИ"/> |
| **Ввод PIN-кода**                                                                                                       | **Первый вход**                                                                                     |

|                                                                                                                                                                   |
|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/user-attachments/assets/9a11a62b-92ed-403e-ba48-a929286b8506" width="600" style="border-radius:22px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); border: 1px solid #333;" alt="Настройки и история"/> |
| **Настройки, история чатов и выбор модели ИИ**                                                                                                                                                                                    |

<br>

</div>
